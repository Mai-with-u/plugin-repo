name: Approve or Reject Plugin

on:
  issue_comment:
    types: [created]

jobs:
  approve:
    if: >-
      (contains(github.event.issue.labels.*.name, 'plugin-submission') ||
       contains(github.event.issue.labels.*.name, 'plugin-modification') ||
       contains(github.event.issue.labels.*.name, 'plugin-removal')) &&
      contains(github.event.issue.labels.*.name, 'validated') &&
      contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Check maintainer permission
        id: check-permission
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: commenter
            });
            
            const allowedPermissions = ['admin', 'write'];
            if (!allowedPermissions.includes(permission.permission)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ @${commenter} åªæœ‰ **ä»“åº“ç»´æŠ¤è€…** (admin/write) å¯ä»¥ä½¿ç”¨ \`/approve\` å‘½ä»¤ã€‚`
              });
              core.setFailed(`ç”¨æˆ· @${commenter} æ²¡æœ‰æƒé™æ‰¹å‡†æ’ä»¶`);
              return;
            }
            
            console.log(`âœ… @${commenter} (${permission.permission}) æ‰§è¡Œ /approve`);
            core.setOutput('approved_by', commenter);

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse issue and add plugin
        id: add-plugin
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const labels = context.payload.issue.labels.map(label => label.name);
            const requestType = labels.includes('plugin-modification')
              ? 'modify'
              : labels.includes('plugin-removal')
                ? 'remove'
                : 'add';
            
            const body = context.payload.issue.body;
            const pluginIdMatch = body.match(/### æ’ä»¶ ID \/ Plugin ID\s*\n\s*\n(.+)/);
            const currentPluginIdMatch = body.match(/### å½“å‰æ’ä»¶ ID \/ Current Plugin ID\s*\n\s*\n(.+)/);
            const newPluginIdMatch = body.match(/### æ–°æ’ä»¶ ID \/ New Plugin ID\s*\n\s*\n(.+)/);
            const addRepoUrlMatch = body.match(/### ä»“åº“åœ°å€ \/ Repository URL\s*\n\s*\n(.+)/);
            const modifyRepoUrlMatch = body.match(/### æ–°çš„ä»“åº“åœ°å€ \/ New Repository URL\s*\n\s*\n(.+)/);
            
            if (requestType === 'modify') {
              if (!currentPluginIdMatch || !newPluginIdMatch) {
                core.setFailed('æ— æ³•è§£æ Issue å†…å®¹ï¼šç¼ºå°‘å½“å‰/æ–°æ’ä»¶ ID');
                return;
              }
            } else if (!pluginIdMatch) {
              core.setFailed('æ— æ³•è§£æ Issue å†…å®¹ï¼šç¼ºå°‘æ’ä»¶ ID');
              return;
            }
            
            const pluginId = requestType === 'modify'
              ? newPluginIdMatch[1].trim()
              : pluginIdMatch[1].trim();
            const currentPluginId = requestType === 'modify'
              ? currentPluginIdMatch[1].trim()
              : pluginId;
            const repoUrl = requestType === 'modify'
              ? modifyRepoUrlMatch && modifyRepoUrlMatch[1].trim()
              : addRepoUrlMatch && addRepoUrlMatch[1].trim();
            
            const plugins = JSON.parse(fs.readFileSync('plugins.json', 'utf8'));
            const existingPluginIndex = requestType === 'modify'
              ? plugins.findIndex(p => p.id === currentPluginId)
              : plugins.findIndex(p => p.id === pluginId);
            
            if (requestType === 'add') {
              if (plugins.some(p => p.id === pluginId)) {
                core.setFailed(`æ’ä»¶ ID å·²å­˜åœ¨: ${pluginId}`);
                return;
              }
              if (plugins.some(p => p.repositoryUrl === repoUrl)) {
                core.setFailed(`ä»“åº“ URL å·²å­˜åœ¨: ${repoUrl}`);
                return;
              }
              if (!repoUrl) {
                core.setFailed('æ— æ³•è§£æ Issue å†…å®¹ï¼šç¼ºå°‘ä»“åº“åœ°å€');
                return;
              }
              
              plugins.push({
                id: pluginId,
                repositoryUrl: repoUrl
              });
            }
            
            if (requestType === 'modify') {
              if (existingPluginIndex === -1) {
                core.setFailed(`æ’ä»¶ ID ä¸å­˜åœ¨: ${currentPluginId}`);
                return;
              }
              const hasRepoChange = Boolean(repoUrl && repoUrl !== plugins[existingPluginIndex].repositoryUrl);
              const hasIdChange = currentPluginId !== pluginId;
              
              if (!hasRepoChange && !hasIdChange) {
                core.setFailed('æœªæ£€æµ‹åˆ°ä¿®æ”¹å†…å®¹');
                return;
              }
              
              if (hasIdChange) {
                if (plugins.some(p => p.id === pluginId)) {
                  core.setFailed(`æ–°æ’ä»¶ ID å·²å­˜åœ¨: ${pluginId}`);
                  return;
                }
              }
              
              if (repoUrl) {
                const duplicateUrl = plugins.find(p => p.repositoryUrl === repoUrl && p.id !== currentPluginId);
                if (duplicateUrl) {
                  core.setFailed(`ä»“åº“ URL å·²å­˜åœ¨: ${repoUrl}`);
                  return;
                }
              }
              
              plugins[existingPluginIndex] = {
                ...plugins[existingPluginIndex],
                id: hasIdChange ? pluginId : plugins[existingPluginIndex].id,
                repositoryUrl: hasRepoChange ? repoUrl : plugins[existingPluginIndex].repositoryUrl
              };
            }
            
            if (requestType === 'remove') {
              if (existingPluginIndex === -1) {
                core.setFailed(`æ’ä»¶ ID ä¸å­˜åœ¨: ${pluginId}`);
                return;
              }
              plugins.splice(existingPluginIndex, 1);
            }
            
            fs.writeFileSync('plugins.json', JSON.stringify(plugins, null, 2) + '\n');
            
            core.setOutput('plugin_id', pluginId);
            if (requestType === 'modify') {
              core.setOutput('current_plugin_id', currentPluginId);
            }
            core.setOutput('repo_url', repoUrl || '');
            core.setOutput('request_type', requestType);

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add plugins.json
          if [ "${{ steps.add-plugin.outputs.request_type }}" = "modify" ]; then
            git commit -m "chore: Update ${{ steps.add-plugin.outputs.plugin_id }} plugin (via #${{ github.event.issue.number }})"
          elif [ "${{ steps.add-plugin.outputs.request_type }}" = "remove" ]; then
            git commit -m "chore: Remove ${{ steps.add-plugin.outputs.plugin_id }} plugin (via #${{ github.event.issue.number }})"
          else
            git commit -m "feat: Add ${{ steps.add-plugin.outputs.plugin_id }} plugin (via #${{ github.event.issue.number }})"
          fi
          git push

      - name: Close issue with success
        uses: actions/github-script@v7
        with:
          script: |
            const pluginId = '${{ steps.add-plugin.outputs.plugin_id }}';
            const approvedBy = '${{ steps.check-permission.outputs.approved_by }}';
            const requestType = '${{ steps.add-plugin.outputs.request_type }}';
            
            const titleMap = {
              add: 'æ’ä»¶å·²æ·»åŠ  / Plugin Added',
              modify: 'æ’ä»¶å·²æ›´æ–° / Plugin Updated',
              remove: 'æ’ä»¶å·²ç§»é™¤ / Plugin Removed'
            };
            const actionMap = {
              add: 'å·²æˆåŠŸæ·»åŠ åˆ°æ’ä»¶ä¸­å¿ƒ',
              modify: 'å·²æˆåŠŸæ›´æ–°ä»“åº“ä¿¡æ¯',
              remove: 'å·²ä»æ’ä»¶ä¸­å¿ƒç§»é™¤'
            };
            const title = titleMap[requestType] || titleMap.add;
            const actionText = actionMap[requestType] || actionMap.add;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ‰ ${title}\n\næ’ä»¶ \`${pluginId}\` ${actionText}ï¼\n\n| ä¿¡æ¯ | å€¼ |\n|------|----|\n| æ‰¹å‡†äºº | @${approvedBy} |\n| å…³è” Issue | #${context.issue.number} |\n\næ’ä»¶è¯¦æƒ…å°†åœ¨ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°åæ˜¾ç¤ºåœ¨ [æ’ä»¶å±•ç¤ºé¡µ](https://plugins.maibot.chat/)\n\næ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ / Thank you for your contribution!`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['approved']
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Handle approve failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âŒ æ·»åŠ å¤±è´¥ / Addition Failed\n\næ’ä»¶æ·»åŠ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ã€‚\n\nè¯·æ£€æŸ¥ [å·¥ä½œæµæ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) è·å–è¯¦ç»†ä¿¡æ¯ã€‚`
            });

  reject:
    if: >-
      (contains(github.event.issue.labels.*.name, 'plugin-submission') ||
       contains(github.event.issue.labels.*.name, 'plugin-modification') ||
       contains(github.event.issue.labels.*.name, 'plugin-removal')) &&
      startsWith(github.event.comment.body, '/reject')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Check maintainer permission and reject
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            const commentBody = context.payload.comment.body;
            
            // æ£€æŸ¥æƒé™
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: commenter
            });
            
            const allowedPermissions = ['admin', 'write'];
            if (!allowedPermissions.includes(permission.permission)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ @${commenter} åªæœ‰ **ä»“åº“ç»´æŠ¤è€…** (admin/write) å¯ä»¥ä½¿ç”¨ \`/reject\` å‘½ä»¤ã€‚`
              });
              core.setFailed(`ç”¨æˆ· @${commenter} æ²¡æœ‰æƒé™æ‹’ç»æ’ä»¶`);
              return;
            }
            
            // è§£ææ‹’ç»åŸå› 
            const reasonMatch = commentBody.match(/^\/reject\s*([\s\S]*)/);
            let reason = reasonMatch && reasonMatch[1].trim();
            
            if (!reason) {
              reason = 'æœªæä¾›å…·ä½“åŸå› ';
            }
            
            console.log(`@${commenter} æ‹’ç»æ’ä»¶ï¼ŒåŸå› : ${reason}`);
            
            // æ·»åŠ æ‹’ç»è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸš« æ’ä»¶è¢«æ‹’ç» / Plugin Rejected\n\næ­¤æ’ä»¶æäº¤å·²è¢«ç»´æŠ¤è€…æ‹’ç»ã€‚\n\n| ä¿¡æ¯ | å€¼ |\n|------|----|\n| æ‹’ç»äºº | @${commenter} |\n| åŸå›  | ${reason} |\n\nå¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»ä»“åº“ç»´æŠ¤è€…ã€‚\n\n---\n\n*å¦‚æœæ‚¨å·²ä¿®æ”¹æ’ä»¶ä»¥ç¬¦åˆè¦æ±‚ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„ Issue é‡æ–°æäº¤ã€‚*`
            });
            
            // ç§»é™¤éªŒè¯ç›¸å…³æ ‡ç­¾ï¼Œæ·»åŠ  rejected æ ‡ç­¾
            const labelsToRemove = ['validated', 'validation-failed', 'pending-validation'];
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label
                });
              } catch (e) {
                // æ ‡ç­¾ä¸å­˜åœ¨ï¼Œå¿½ç•¥
              }
            }
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['rejected']
            });
            
            // å…³é—­ Issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
